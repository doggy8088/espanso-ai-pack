name: Process Prompt Contribution

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]

jobs:
  re-validate:
    name: é‡æ–°é©—è­‰æç¤ºè©
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' &&
      (github.event.issue.labels.*.name == 'prompt-contribution' ||
       contains(github.event.issue.labels.*.name, 'prompt-contribution'))
    permissions:
      contents: read
      issues: write
    steps:
      - name: Add eyes reaction
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              content: 'eyes'
            });

      - name: Check if re-validation requested
        id: check-command
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment;
            const issue = context.payload.issue;

            // æª¢æŸ¥æ˜¯å¦ç‚º /check æŒ‡ä»¤
            if (!comment.body.trim().toLowerCase().startsWith('/check')) {
              console.log('ä¸æ˜¯ /check æŒ‡ä»¤ï¼Œè·³é');
              return { shouldValidate: false };
            }

            // æª¢æŸ¥æ˜¯å¦ç‚º repo owner æˆ–æœ‰ write æ¬Šé™
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: comment.user.login
            });

            const hasWriteAccess = ['admin', 'write'].includes(permission.permission);

            if (!hasWriteAccess) {
              console.log(`ä½¿ç”¨è€… ${comment.user.login} æ²’æœ‰è¶³å¤ æ¬Šé™`);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'âŒ æŠ±æ­‰ï¼Œåªæœ‰å°ˆæ¡ˆç¶­è­·è€…å¯ä»¥åŸ·è¡Œ `/check` æŒ‡ä»¤ã€‚'
              });
              return { shouldValidate: false };
            }

            console.log(`ä½¿ç”¨è€… ${comment.user.login} æœ‰æ¬Šé™ï¼Œé–‹å§‹é‡æ–°é©—è­‰`);
            return { shouldValidate: true };

      - name: Checkout
        if: steps.check-command.outputs.result != '' && fromJSON(steps.check-command.outputs.result).shouldValidate
        uses: actions/checkout@v4

      - name: Re-validate issue content
        if: steps.check-command.outputs.result != '' && fromJSON(steps.check-command.outputs.result).shouldValidate
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body;

            // è§£æ Issue å…§å®¹
            const triggerMatch = body.match(/### Trigger\s*\n+([^\n]+)/i);
            const filenameMatch = body.match(/### æª”æ¡ˆåç¨±\s*\n+([^\n]+)/i);
            const labelMatch = body.match(/### Label\s*\n+([^\n]+)/i);
            const descriptionMatch = body.match(/### Description\s*\n+([\s\S]*?)(?=### Prompt|$)/i);
            const promptMatch = body.match(/### Prompt\s*\n+```[\s\S]*?\n([\s\S]*?)```/i) ||
                               body.match(/### Prompt\s*\n+([\s\S]*?)(?=### |$)/i);

            // æª¢æŸ¥æ˜¯å¦æˆåŠŸè§£ææ‰€æœ‰æ¬„ä½
            const parseErrors = [];
            if (!triggerMatch) parseErrors.push('âŒ ç„¡æ³•è§£æ Trigger');
            if (!filenameMatch) parseErrors.push('âŒ ç„¡æ³•è§£æ æª”æ¡ˆåç¨±');
            if (!labelMatch) parseErrors.push('âŒ ç„¡æ³•è§£æ Label');
            if (!descriptionMatch) parseErrors.push('âŒ ç„¡æ³•è§£æ Description');
            if (!promptMatch) parseErrors.push('âŒ ç„¡æ³•è§£æ Prompt');

            if (parseErrors.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `ğŸ”„ **é‡æ–°é©—è­‰çµæœ**\n\nâŒ **ç„¡æ³•è§£ææç¤ºè©å…§å®¹ï¼Œè«‹ç¢ºä¿æ ¼å¼æ­£ç¢ºã€‚**\n\n**è§£æçµæœï¼š**\n${parseErrors.join('\n')}\n\nè«‹åƒè€ƒ Issue æ¨¡æ¿ç¢ºä¿æ ¼å¼æ­£ç¢ºå¾Œé‡æ–°ç·¨è¼¯ã€‚`
              });
              return;
            }

            const trigger = triggerMatch[1].trim();
            const filename = filenameMatch[1].trim();
            const label = labelMatch[1].trim();
            const description = descriptionMatch[1].trim();
            const prompt = promptMatch[1].trim();

            // é©—è­‰ trigger æ ¼å¼
            const validationErrors = [];

            if (!trigger.startsWith(':')) {
              validationErrors.push('âš ï¸ Trigger å¿…é ˆä»¥å†’è™Ÿ `:` é–‹é ­');
            }

            if (trigger.includes(' ')) {
              validationErrors.push('âš ï¸ Trigger ä¸å¯åŒ…å«ç©ºæ ¼');
            }

            if (trigger.length < 2) {
              validationErrors.push('âš ï¸ Trigger é•·åº¦è‡³å°‘éœ€è¦ 2 å€‹å­—å…ƒ');
            }

            if (!/^[a-z0-9-]+$/.test(filename)) {
              validationErrors.push('âš ï¸ æª”æ¡ˆåç¨±åªèƒ½åŒ…å«å°å¯«è‹±æ–‡ã€æ•¸å­—å’Œç ´æŠ˜è™Ÿ');
            }

            if (prompt.length < 10) {
              validationErrors.push('âš ï¸ Prompt å…§å®¹éçŸ­ï¼ˆè‡³å°‘ 10 å€‹å­—å…ƒï¼‰');
            }

            if (validationErrors.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `ğŸ”„ **é‡æ–°é©—è­‰çµæœ**\n\nâŒ **æç¤ºè©æ ¼å¼é©—è­‰å¤±æ•—**\n\n${validationErrors.join('\n')}\n\nè«‹ç·¨è¼¯ Issue ä¿®æ­£é€™äº›å•é¡Œã€‚`
              });
              return;
            }

            // ä½¿ç”¨ä½¿ç”¨è€…æä¾›çš„æª”æ¡ˆåç¨±
            const fileName = filename + '.yml';

            // æª¢æŸ¥æª”æ¡ˆåç¨±æ˜¯å¦é‡è¤‡
            const { execSync } = require('child_process');
            const fs = require('fs');
            
            if (fs.existsSync(`prompts/${fileName}`)) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `ğŸ”„ **é‡æ–°é©—è­‰çµæœ**\n\nâŒ **æª”æ¡ˆåç¨±é‡è¤‡**\n\næª”æ¡ˆ \`prompts/${fileName}\` å·²ç¶“å­˜åœ¨ï¼Œè«‹ä½¿ç”¨ä¸åŒçš„æª”æ¡ˆåç¨±ã€‚\n\næ‚¨å¯ä»¥ç€è¦½ [prompts/ ç›®éŒ„](https://github.com/${context.repo.owner}/${context.repo.repo}/tree/main/prompts) æŸ¥çœ‹ç¾æœ‰çš„æª”æ¡ˆã€‚`
              });
              return;
            }

            // æª¢æŸ¥é‡è¤‡ trigger
            let isDuplicateTrigger = false;
            try {
              execSync(`grep -r "trigger: \\"${trigger}\\"" prompts/ 2>/dev/null || grep -r "trigger: ${trigger}" prompts/ 2>/dev/null`);
              isDuplicateTrigger = true;
            } catch (e) {
              // grep æ²’æ‰¾åˆ°æ™‚æœƒæ‹‹å‡ºéŒ¯èª¤ï¼Œé€™æ˜¯æ­£å¸¸çš„
            }

            // ç”Ÿæˆ YAML æª”æ¡ˆå…§å®¹
            const issueAuthor = issue.user.login;
            const issueNumber = issue.number;

            // è™•ç† prompt ç¸®æ’ï¼ˆæ¯è¡Œå‰åŠ å…©å€‹ç©ºæ ¼ï¼‰
            const indentedPrompt = prompt.split('\n').map(line => `  ${line}`).join('\n');

            const yamlContent = `# æç¤ºè©ç”± Issue #${issueNumber} è²¢ç»
            # è²¢ç»è€…: @${issueAuthor}

            trigger: "${trigger}"
            label: "${label}"
            description: "${description}"

            prompt: |
            ${indentedPrompt}`;

            // å»ºç«‹é©—è­‰è¨Šæ¯
            let validationMessage = `ğŸ”„ **é‡æ–°é©—è­‰çµæœ**\n\nâœ… **æç¤ºè©é©—è­‰æˆåŠŸï¼**

            ä»¥ä¸‹æ˜¯å³å°‡å»ºç«‹çš„æª”æ¡ˆå…§å®¹ï¼š

            **æª”æ¡ˆåç¨±ï¼š** \`prompts/${fileName}\`

            \`\`\`yaml
            ${yamlContent}
            \`\`\`

            ---

            **é©—è­‰çµæœï¼š**
            - âœ… Trigger æ ¼å¼æ­£ç¢º
            - âœ… æ‰€æœ‰å¿…è¦æ¬„ä½å®Œæ•´
            - ${isDuplicateTrigger ? 'âš ï¸ Trigger é‡è¤‡ï¼ˆå…è¨±ï¼Œä½†è«‹ç¢ºèªæª”åä¸åŒï¼‰' : 'âœ… ç„¡é‡è¤‡ Trigger'}
            - âœ… å…§å®¹é•·åº¦ç¬¦åˆè¦æ±‚`;

            if (isDuplicateTrigger) {
              validationMessage += `\n\n---\n\nâš ï¸ **æé†’**ï¼šé€™å€‹ Trigger \`${trigger}\` å·²ç¶“å­˜åœ¨æ–¼å°ˆæ¡ˆä¸­ã€‚åªè¦æª”æ¡ˆåç¨±ä¸åŒå³å¯åˆä½µã€‚æ‚¨å¯ä»¥æœå°‹ [prompts/ ç›®éŒ„](https://github.com/${context.repo.owner}/${context.repo.repo}/tree/main/prompts) æŸ¥çœ‹ç¾æœ‰çš„ Triggerã€‚`;
            }

            validationMessage += `\n\n**ä¸‹ä¸€æ­¥ï¼š**\nç¶­è­·è€…å¯ä»¥è¼¸å…¥ \`/approved\` ä¾†æ ¸å‡†æ­¤æç¤ºè©ï¼Œç³»çµ±å°‡è‡ªå‹•å»ºç«‹ä¸Šè¿°æª”æ¡ˆä¸¦åˆä½µè‡³å°ˆæ¡ˆã€‚`;

            // ç™¼é€æˆåŠŸè¨Šæ¯ï¼ŒåŒ…å«å®Œæ•´çš„ YAML å…§å®¹
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: validationMessage
            });

            console.log(`é‡æ–°é©—è­‰æˆåŠŸ: ${fileName}`);
            console.log(`Trigger: ${trigger}`);

      - name: Remove eyes reaction
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const reactions = await github.rest.reactions.listForIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number
            });
            
            const eyesReaction = reactions.data.find(r => 
              r.content === 'eyes' && r.user.type === 'Bot'
            );
            
            if (eyesReaction) {
              await github.rest.reactions.deleteForIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                reaction_id: eyesReaction.id
              });
            }

  process-approval:
    name: è™•ç†æç¤ºè©å¯©æ ¸
    runs-on: ubuntu-latest
    if: |
      github.event.issue.labels.*.name == 'prompt-contribution' ||
      contains(github.event.issue.labels.*.name, 'prompt-contribution')
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Add eyes reaction
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              content: 'eyes'
            });

      - name: Check if approved by owner
        id: check-approval
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment;
            const issue = context.payload.issue;

            // æª¢æŸ¥æ˜¯å¦ç‚ºè©•è«–äº‹ä»¶
            if (!comment) {
              console.log('ä¸æ˜¯è©•è«–äº‹ä»¶ï¼Œè·³é');
              return { approved: false };
            }

            // æª¢æŸ¥æ˜¯å¦ç‚º /approved æŒ‡ä»¤
            if (!comment.body.trim().toLowerCase().startsWith('/approved')) {
              console.log('ä¸æ˜¯ /approved æŒ‡ä»¤ï¼Œè·³é');
              return { approved: false };
            }

            // æª¢æŸ¥æ˜¯å¦ç‚º repo owner æˆ–æœ‰ write æ¬Šé™
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: comment.user.login
            });

            const hasWriteAccess = ['admin', 'write'].includes(permission.permission);

            if (!hasWriteAccess) {
              console.log(`ä½¿ç”¨è€… ${comment.user.login} æ²’æœ‰è¶³å¤ æ¬Šé™`);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'âŒ æŠ±æ­‰ï¼Œåªæœ‰å°ˆæ¡ˆç¶­è­·è€…å¯ä»¥æ ¸å‡†æç¤ºè©ã€‚'
              });
              return { approved: false };
            }

            console.log(`ä½¿ç”¨è€… ${comment.user.login} æœ‰æ¬Šé™ï¼Œè™•ç†æ ¸å‡†`);
            return {
              approved: true,
              issueNumber: issue.number,
              issueBody: issue.body,
              issueTitle: issue.title
            };

      - name: Checkout
        if: steps.check-approval.outputs.result != '' && fromJSON(steps.check-approval.outputs.result).approved
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        if: steps.check-approval.outputs.result != '' && fromJSON(steps.check-approval.outputs.result).approved
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        if: steps.check-approval.outputs.result != '' && fromJSON(steps.check-approval.outputs.result).approved
        run: bun install

      - name: Parse and validate prompt
        if: steps.check-approval.outputs.result != '' && fromJSON(steps.check-approval.outputs.result).approved
        id: parse-prompt
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body;

            // è§£æ Issue å…§å®¹
            const triggerMatch = body.match(/### Trigger\s*\n+([^\n]+)/i);
            const filenameMatch = body.match(/### æª”æ¡ˆåç¨±\s*\n+([^\n]+)/i);
            const labelMatch = body.match(/### Label\s*\n+([^\n]+)/i);
            const descriptionMatch = body.match(/### Description\s*\n+([\s\S]*?)(?=### Prompt|$)/i);
            const promptMatch = body.match(/### Prompt\s*\n+```[\s\S]*?\n([\s\S]*?)```/i) ||
                               body.match(/### Prompt\s*\n+([\s\S]*?)(?=### |$)/i);

            if (!triggerMatch || !filenameMatch || !labelMatch || !descriptionMatch || !promptMatch) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `âŒ ç„¡æ³•è§£ææç¤ºè©å…§å®¹ï¼Œè«‹ç¢ºä¿æ ¼å¼æ­£ç¢ºã€‚\n\n**è§£æçµæœï¼š**\n- Trigger: ${triggerMatch ? 'âœ…' : 'âŒ'}\n- æª”æ¡ˆåç¨±: ${filenameMatch ? 'âœ…' : 'âŒ'}\n- Label: ${labelMatch ? 'âœ…' : 'âŒ'}\n- Description: ${descriptionMatch ? 'âœ…' : 'âŒ'}\n- Prompt: ${promptMatch ? 'âœ…' : 'âŒ'}`
              });
              return { valid: false };
            }

            const trigger = triggerMatch[1].trim();
            const filename = filenameMatch[1].trim();
            const label = labelMatch[1].trim();
            const description = descriptionMatch[1].trim();
            const prompt = promptMatch[1].trim();

            // é©—è­‰ trigger æ ¼å¼
            const errors = [];

            if (!trigger.startsWith(':')) {
              errors.push('Trigger å¿…é ˆä»¥å†’è™Ÿ `:` é–‹é ­');
            }

            if (trigger.includes(' ')) {
              errors.push('Trigger ä¸å¯åŒ…å«ç©ºæ ¼');
            }

            if (trigger.length < 2) {
              errors.push('Trigger é•·åº¦è‡³å°‘éœ€è¦ 2 å€‹å­—å…ƒ');
            }

            if (!/^[a-z0-9-]+$/.test(filename)) {
              errors.push('æª”æ¡ˆåç¨±åªèƒ½åŒ…å«å°å¯«è‹±æ–‡ã€æ•¸å­—å’Œç ´æŠ˜è™Ÿ');
            }

            if (prompt.length < 10) {
              errors.push('Prompt å…§å®¹éçŸ­');
            }

            if (errors.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `âŒ æç¤ºè©æ ¼å¼é©—è­‰å¤±æ•—ï¼š\n\n${errors.map(e => `- ${e}`).join('\n')}`
              });
              return { valid: false };
            }

            // ä½¿ç”¨ä½¿ç”¨è€…æä¾›çš„æª”æ¡ˆåç¨±
            const fileName = filename + '.yml';

            // æª¢æŸ¥æª”æ¡ˆåç¨±æ˜¯å¦é‡è¤‡
            const fs = require('fs');
            
            if (fs.existsSync(`prompts/${fileName}`)) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `âŒ **æª”æ¡ˆåç¨±é‡è¤‡**\n\næª”æ¡ˆ \`prompts/${fileName}\` å·²ç¶“å­˜åœ¨ï¼Œè«‹ä½¿ç”¨ä¸åŒçš„æª”æ¡ˆåç¨±ã€‚\n\næ‚¨å¯ä»¥ç€è¦½ [prompts/ ç›®éŒ„](https://github.com/${context.repo.owner}/${context.repo.repo}/tree/main/prompts) æŸ¥çœ‹ç¾æœ‰çš„æª”æ¡ˆã€‚`
              });
              return { valid: false, duplicateFile: true };
            }

            return {
              valid: true,
              trigger,
              label,
              description,
              prompt,
              fileName
            };

      - name: Check for duplicate trigger
        if: |
          steps.check-approval.outputs.result != '' &&
          fromJSON(steps.check-approval.outputs.result).approved &&
          steps.parse-prompt.outputs.result != '' &&
          fromJSON(steps.parse-prompt.outputs.result).valid
        id: check-duplicate
        run: |
          TRIGGER="${{ fromJSON(steps.parse-prompt.outputs.result).trigger }}"
          if grep -r "trigger: \"$TRIGGER\"" prompts/ 2>/dev/null || grep -r "trigger: $TRIGGER" prompts/ 2>/dev/null; then
            echo "duplicate=true" >> $GITHUB_OUTPUT
          else
            echo "duplicate=false" >> $GITHUB_OUTPUT
          fi

      - name: Report duplicate
        if: |
          steps.check-duplicate.outputs.duplicate == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const trigger = '${{ fromJSON(steps.parse-prompt.outputs.result).trigger }}';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `âš ï¸ **æé†’**ï¼šé€™å€‹ Trigger \`${trigger}\` å·²ç¶“å­˜åœ¨æ–¼å°ˆæ¡ˆä¸­ã€‚\n\nåªè¦æª”æ¡ˆåç¨±ä¸åŒå³å¯åˆä½µã€‚æ‚¨å¯ä»¥æœå°‹ [prompts/ ç›®éŒ„](https://github.com/${context.repo.owner}/${context.repo.repo}/tree/main/prompts) æŸ¥çœ‹ç¾æœ‰çš„ Triggerã€‚`
            });

      - name: Create prompt file
        if: |
          steps.check-approval.outputs.result != '' &&
          fromJSON(steps.check-approval.outputs.result).approved &&
          steps.parse-prompt.outputs.result != '' &&
          fromJSON(steps.parse-prompt.outputs.result).valid
        run: |
          TRIGGER='${{ fromJSON(steps.parse-prompt.outputs.result).trigger }}'
          LABEL='${{ fromJSON(steps.parse-prompt.outputs.result).label }}'
          DESCRIPTION='${{ fromJSON(steps.parse-prompt.outputs.result).description }}'
          PROMPT='${{ fromJSON(steps.parse-prompt.outputs.result).prompt }}'
          FILENAME='${{ fromJSON(steps.parse-prompt.outputs.result).fileName }}'
          ISSUE_NUMBER='${{ github.event.issue.number }}'
          ISSUE_AUTHOR='${{ github.event.issue.user.login }}'

          cat > "prompts/$FILENAME" << PROMPT_EOF
          # æç¤ºè©ç”± Issue #$ISSUE_NUMBER è²¢ç»
          # è²¢ç»è€…: @$ISSUE_AUTHOR

          trigger: "$TRIGGER"
          label: "$LABEL"
          description: "$DESCRIPTION"

          prompt: |
          PROMPT_EOF

          # è™•ç†å¤šè¡Œ prompt
          echo "$PROMPT" | sed 's/^/  /' >> "prompts/$FILENAME"

      - name: Build package
        if: |
          steps.check-approval.outputs.result != '' &&
          fromJSON(steps.check-approval.outputs.result).approved &&
          steps.parse-prompt.outputs.result != '' &&
          fromJSON(steps.parse-prompt.outputs.result).valid
        run: bun run build

      - name: Commit and push
        if: |
          steps.check-approval.outputs.result != '' &&
          fromJSON(steps.check-approval.outputs.result).approved &&
          steps.parse-prompt.outputs.result != '' &&
          fromJSON(steps.parse-prompt.outputs.result).valid
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          FILENAME='${{ fromJSON(steps.parse-prompt.outputs.result).fileName }}'
          TRIGGER='${{ fromJSON(steps.parse-prompt.outputs.result).trigger }}'

          git add "prompts/$FILENAME"
          git add "dist/"
          git add "_manifest.yml"
          git commit -m "feat: add prompt $TRIGGER from #${{ github.event.issue.number }}"
          git push

      - name: Close issue with success message
        if: |
          steps.check-approval.outputs.result != '' &&
          fromJSON(steps.check-approval.outputs.result).approved &&
          steps.parse-prompt.outputs.result != '' &&
          fromJSON(steps.parse-prompt.outputs.result).valid
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const result = ${{ steps.parse-prompt.outputs.result }};

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `âœ… æç¤ºè©å·²æˆåŠŸåŠ å…¥ï¼\n\n**è©³ç´°è³‡è¨Šï¼š**\n- Trigger: \`${result.trigger}\`\n- æª”æ¡ˆ: \`prompts/${result.fileName}\`\n\næ„Ÿè¬æ‚¨çš„è²¢ç»ï¼ğŸ‰`
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed',
              labels: ['prompt-contribution', 'approved']
            });

      - name: Remove eyes reaction
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const reactions = await github.rest.reactions.listForIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number
            });
            
            const eyesReaction = reactions.data.find(r => 
              r.content === 'eyes' && r.user.type === 'Bot'
            );
            
            if (eyesReaction) {
              await github.rest.reactions.deleteForIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                reaction_id: eyesReaction.id
              });
            }

  validate-on-create:
    name: é©—è­‰æ–°å»º Issue
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    permissions:
      issues: write
      contents: read
    steps:
      - name: Add eyes reaction
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);
            
            if (!labels.includes('prompt-contribution')) {
              return;
            }
            
            await github.rest.reactions.createForIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              content: 'eyes'
            });

      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse and validate issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);

            if (!labels.includes('prompt-contribution')) {
              return;
            }

            const body = issue.body;

            // è§£æ Issue å…§å®¹
            const triggerMatch = body.match(/### Trigger\s*\n+([^\n]+)/i);
            const filenameMatch = body.match(/### æª”æ¡ˆåç¨±\s*\n+([^\n]+)/i);
            const labelMatch = body.match(/### Label\s*\n+([^\n]+)/i);
            const descriptionMatch = body.match(/### Description\s*\n+([\s\S]*?)(?=### Prompt|$)/i);
            const promptMatch = body.match(/### Prompt\s*\n+```[\s\S]*?\n([\s\S]*?)```/i) ||
                               body.match(/### Prompt\s*\n+([\s\S]*?)(?=### |$)/i);

            // æª¢æŸ¥æ˜¯å¦æˆåŠŸè§£ææ‰€æœ‰æ¬„ä½
            const parseErrors = [];
            if (!triggerMatch) parseErrors.push('âŒ ç„¡æ³•è§£æ Trigger');
            if (!filenameMatch) parseErrors.push('âŒ ç„¡æ³•è§£æ æª”æ¡ˆåç¨±');
            if (!labelMatch) parseErrors.push('âŒ ç„¡æ³•è§£æ Label');
            if (!descriptionMatch) parseErrors.push('âŒ ç„¡æ³•è§£æ Description');
            if (!promptMatch) parseErrors.push('âŒ ç„¡æ³•è§£æ Prompt');

            if (parseErrors.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `âŒ **ç„¡æ³•è§£ææç¤ºè©å…§å®¹ï¼Œè«‹ç¢ºä¿æ ¼å¼æ­£ç¢ºã€‚**\n\n**è§£æçµæœï¼š**\n${parseErrors.join('\n')}\n\nè«‹åƒè€ƒ Issue æ¨¡æ¿ç¢ºä¿æ ¼å¼æ­£ç¢ºå¾Œé‡æ–°ç·¨è¼¯ã€‚`
              });
              return;
            }

            const trigger = triggerMatch[1].trim();
            const filename = filenameMatch[1].trim();
            const label = labelMatch[1].trim();
            const description = descriptionMatch[1].trim();
            const prompt = promptMatch[1].trim();

            // é©—è­‰ trigger æ ¼å¼
            const validationErrors = [];

            if (!trigger.startsWith(':')) {
              validationErrors.push('âš ï¸ Trigger å¿…é ˆä»¥å†’è™Ÿ `:` é–‹é ­');
            }

            if (trigger.includes(' ')) {
              validationErrors.push('âš ï¸ Trigger ä¸å¯åŒ…å«ç©ºæ ¼');
            }

            if (trigger.length < 2) {
              validationErrors.push('âš ï¸ Trigger é•·åº¦è‡³å°‘éœ€è¦ 2 å€‹å­—å…ƒ');
            }

            if (!/^[a-z0-9-]+$/.test(filename)) {
              validationErrors.push('âš ï¸ æª”æ¡ˆåç¨±åªèƒ½åŒ…å«å°å¯«è‹±æ–‡ã€æ•¸å­—å’Œç ´æŠ˜è™Ÿ');
            }

            if (prompt.length < 10) {
              validationErrors.push('âš ï¸ Prompt å…§å®¹éçŸ­ï¼ˆè‡³å°‘ 10 å€‹å­—å…ƒï¼‰');
            }

            if (validationErrors.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `âŒ **æç¤ºè©æ ¼å¼é©—è­‰å¤±æ•—**\n\n${validationErrors.join('\n')}\n\nè«‹ç·¨è¼¯ Issue ä¿®æ­£é€™äº›å•é¡Œå¾Œï¼Œç³»çµ±æœƒè‡ªå‹•é‡æ–°é©—è­‰ã€‚`
              });
              return;
            }

            // ä½¿ç”¨ä½¿ç”¨è€…æä¾›çš„æª”æ¡ˆåç¨±
            const fileName = filename + '.yml';

            // æª¢æŸ¥æª”æ¡ˆåç¨±æ˜¯å¦é‡è¤‡
            const { execSync } = require('child_process');
            const fs = require('fs');
            
            if (fs.existsSync(`prompts/${fileName}`)) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `âŒ **æª”æ¡ˆåç¨±é‡è¤‡**\n\næª”æ¡ˆ \`prompts/${fileName}\` å·²ç¶“å­˜åœ¨ï¼Œè«‹ä½¿ç”¨ä¸åŒçš„æª”æ¡ˆåç¨±ã€‚\n\næ‚¨å¯ä»¥ç€è¦½ [prompts/ ç›®éŒ„](https://github.com/${context.repo.owner}/${context.repo.repo}/tree/main/prompts) æŸ¥çœ‹ç¾æœ‰çš„æª”æ¡ˆã€‚`
              });
              return;
            }

            // æª¢æŸ¥é‡è¤‡ triggerï¼ˆåƒ…æé†’ï¼Œä¸é˜»æ­¢ï¼‰
            let isDuplicateTrigger = false;
            try {
              execSync(`grep -r "trigger: \\"${trigger}\\"" prompts/ 2>/dev/null || grep -r "trigger: ${trigger}" prompts/ 2>/dev/null`);
              isDuplicateTrigger = true;
            } catch (e) {
              // grep æ²’æ‰¾åˆ°æ™‚æœƒæ‹‹å‡ºéŒ¯èª¤ï¼Œé€™æ˜¯æ­£å¸¸çš„
            }

            // ç”Ÿæˆ YAML æª”æ¡ˆå…§å®¹
            const issueAuthor = issue.user.login;
            const issueNumber = issue.number;

            // è™•ç† prompt ç¸®æ’ï¼ˆæ¯è¡Œå‰åŠ å…©å€‹ç©ºæ ¼ï¼‰
            const indentedPrompt = prompt.split('\n').map(line => `  ${line}`).join('\n');

            const yamlContent = `# æç¤ºè©ç”± Issue #${issueNumber} è²¢ç»
            # è²¢ç»è€…: @${issueAuthor}

            trigger: "${trigger}"
            label: "${label}"
            description: "${description}"

            prompt: |
            ${indentedPrompt}`;

            // å»ºç«‹é©—è­‰è¨Šæ¯
            let validationMessage = `âœ… **æç¤ºè©é©—è­‰æˆåŠŸï¼**

            æ„Ÿè¬æ‚¨çš„è²¢ç»ï¼ä»¥ä¸‹æ˜¯å³å°‡å»ºç«‹çš„æª”æ¡ˆå…§å®¹ï¼š

            **æª”æ¡ˆåç¨±ï¼š** \`prompts/${fileName}\`

            \`\`\`yaml
            ${yamlContent}
            \`\`\`

            ---

            **é©—è­‰çµæœï¼š**
            - âœ… Trigger æ ¼å¼æ­£ç¢º
            - âœ… æ‰€æœ‰å¿…è¦æ¬„ä½å®Œæ•´
            - ${isDuplicateTrigger ? 'âš ï¸ Trigger é‡è¤‡ï¼ˆå…è¨±ï¼Œä½†è«‹ç¢ºèªæª”åä¸åŒï¼‰' : 'âœ… ç„¡é‡è¤‡ Trigger'}
            - âœ… å…§å®¹é•·åº¦ç¬¦åˆè¦æ±‚`;

            if (isDuplicateTrigger) {
              validationMessage += `\n\n---\n\nâš ï¸ **æé†’**ï¼šé€™å€‹ Trigger \`${trigger}\` å·²ç¶“å­˜åœ¨æ–¼å°ˆæ¡ˆä¸­ã€‚åªè¦æª”æ¡ˆåç¨±ä¸åŒå³å¯åˆä½µã€‚æ‚¨å¯ä»¥æœå°‹ [prompts/ ç›®éŒ„](https://github.com/${context.repo.owner}/${context.repo.repo}/tree/main/prompts) æŸ¥çœ‹ç¾æœ‰çš„ Triggerã€‚`;
            }

            validationMessage += `\n\n**ä¸‹ä¸€æ­¥ï¼š**\nç¶­è­·è€…å¯ä»¥è¼¸å…¥ \`/approved\` ä¾†æ ¸å‡†æ­¤æç¤ºè©ï¼Œç³»çµ±å°‡è‡ªå‹•å»ºç«‹ä¸Šè¿°æª”æ¡ˆä¸¦åˆä½µè‡³å°ˆæ¡ˆã€‚`;

            // ç™¼é€æˆåŠŸè¨Šæ¯ï¼ŒåŒ…å«å®Œæ•´çš„ YAML å…§å®¹
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: validationMessage
            });

            console.log(`é©—è­‰æˆåŠŸ: ${fileName}`);
            console.log(`Trigger: ${trigger}`);
            console.log(`æª”æ¡ˆå°‡å»ºç«‹æ–¼: prompts/${fileName}`);

      - name: Remove eyes reaction
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);
            
            if (!labels.includes('prompt-contribution')) {
              return;
            }
            
            const reactions = await github.rest.reactions.listForIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number
            });
            
            const eyesReaction = reactions.data.find(r => 
              r.content === 'eyes' && r.user.type === 'Bot'
            );
            
            if (eyesReaction) {
              await github.rest.reactions.deleteForIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                reaction_id: eyesReaction.id
              });
            }
