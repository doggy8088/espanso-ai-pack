name: Process Prompt Contribution

on:
  issue_comment:
    types: [created]

jobs:
  process-approval:
    name: è™•ç†æç¤ºè©å¯©æ ¸
    runs-on: ubuntu-latest
    if: |
      github.event.issue.labels.*.name == 'prompt-contribution' || 
      contains(github.event.issue.labels.*.name, 'prompt-contribution')
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Check if approved by owner
        id: check-approval
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment;
            const issue = context.payload.issue;
            
            // æª¢æŸ¥æ˜¯å¦ç‚º /approved æŒ‡ä»¤
            if (!comment.body.trim().toLowerCase().startsWith('/approved')) {
              console.log('ä¸æ˜¯ /approved æŒ‡ä»¤ï¼Œè·³é');
              return { approved: false };
            }
            
            // æª¢æŸ¥æ˜¯å¦ç‚º repo owner æˆ–æœ‰ write æ¬Šé™
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: comment.user.login
            });
            
            const hasWriteAccess = ['admin', 'write'].includes(permission.permission);
            
            if (!hasWriteAccess) {
              console.log(`ä½¿ç”¨è€… ${comment.user.login} æ²’æœ‰è¶³å¤ æ¬Šé™`);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'âŒ æŠ±æ­‰ï¼Œåªæœ‰å°ˆæ¡ˆç¶­è­·è€…å¯ä»¥æ ¸å‡†æç¤ºè©ã€‚'
              });
              return { approved: false };
            }
            
            console.log(`ä½¿ç”¨è€… ${comment.user.login} æœ‰æ¬Šé™ï¼Œè™•ç†æ ¸å‡†`);
            return { 
              approved: true,
              issueNumber: issue.number,
              issueBody: issue.body,
              issueTitle: issue.title
            };

      - name: Checkout
        if: steps.check-approval.outputs.result != '' && fromJSON(steps.check-approval.outputs.result).approved
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        if: steps.check-approval.outputs.result != '' && fromJSON(steps.check-approval.outputs.result).approved
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        if: steps.check-approval.outputs.result != '' && fromJSON(steps.check-approval.outputs.result).approved
        run: bun install

      - name: Parse and validate prompt
        if: steps.check-approval.outputs.result != '' && fromJSON(steps.check-approval.outputs.result).approved
        id: parse-prompt
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body;
            
            // è§£æ Issue å…§å®¹
            const triggerMatch = body.match(/### Trigger\s*\n+([^\n]+)/i);
            const labelMatch = body.match(/### Label\s*\n+([^\n]+)/i);
            const descriptionMatch = body.match(/### Description\s*\n+([\s\S]*?)(?=### Prompt|$)/i);
            const promptMatch = body.match(/### Prompt\s*\n+```[\s\S]*?\n([\s\S]*?)```/i) || 
                               body.match(/### Prompt\s*\n+([\s\S]*?)(?=### |$)/i);
            
            if (!triggerMatch || !labelMatch || !descriptionMatch || !promptMatch) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `âŒ ç„¡æ³•è§£ææç¤ºè©å…§å®¹ï¼Œè«‹ç¢ºä¿æ ¼å¼æ­£ç¢ºã€‚\n\n**è§£æçµæœï¼š**\n- Trigger: ${triggerMatch ? 'âœ…' : 'âŒ'}\n- Label: ${labelMatch ? 'âœ…' : 'âŒ'}\n- Description: ${descriptionMatch ? 'âœ…' : 'âŒ'}\n- Prompt: ${promptMatch ? 'âœ…' : 'âŒ'}`
              });
              return { valid: false };
            }
            
            const trigger = triggerMatch[1].trim();
            const label = labelMatch[1].trim();
            const description = descriptionMatch[1].trim();
            const prompt = promptMatch[1].trim();
            
            // é©—è­‰ trigger æ ¼å¼
            const errors = [];
            
            if (!trigger.startsWith(':')) {
              errors.push('Trigger å¿…é ˆä»¥å†’è™Ÿ `:` é–‹é ­');
            }
            
            if (trigger.includes(' ')) {
              errors.push('Trigger ä¸å¯åŒ…å«ç©ºæ ¼');
            }
            
            if (trigger.length < 2) {
              errors.push('Trigger é•·åº¦è‡³å°‘éœ€è¦ 2 å€‹å­—å…ƒ');
            }
            
            if (prompt.length < 10) {
              errors.push('Prompt å…§å®¹éçŸ­');
            }
            
            if (errors.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `âŒ æç¤ºè©æ ¼å¼é©—è­‰å¤±æ•—ï¼š\n\n${errors.map(e => `- ${e}`).join('\n')}`
              });
              return { valid: false };
            }
            
            // ç”Ÿæˆæª”æ¡ˆåç¨±
            const fileName = trigger.replace(/^:/, '').replace(/[^a-zA-Z0-9-]/g, '-') + '.yml';
            
            return {
              valid: true,
              trigger,
              label,
              description,
              prompt,
              fileName
            };

      - name: Check for duplicate trigger
        if: |
          steps.check-approval.outputs.result != '' && 
          fromJSON(steps.check-approval.outputs.result).approved &&
          steps.parse-prompt.outputs.result != '' &&
          fromJSON(steps.parse-prompt.outputs.result).valid
        id: check-duplicate
        run: |
          TRIGGER="${{ fromJSON(steps.parse-prompt.outputs.result).trigger }}"
          if grep -r "trigger: \"$TRIGGER\"" prompts/ 2>/dev/null || grep -r "trigger: $TRIGGER" prompts/ 2>/dev/null; then
            echo "duplicate=true" >> $GITHUB_OUTPUT
          else
            echo "duplicate=false" >> $GITHUB_OUTPUT
          fi

      - name: Report duplicate
        if: |
          steps.check-duplicate.outputs.duplicate == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: 'âŒ é€™å€‹ Trigger å·²ç¶“å­˜åœ¨ï¼Œè«‹ä½¿ç”¨ä¸åŒçš„ Triggerã€‚'
            });

      - name: Create prompt file
        if: |
          steps.check-approval.outputs.result != '' && 
          fromJSON(steps.check-approval.outputs.result).approved &&
          steps.parse-prompt.outputs.result != '' &&
          fromJSON(steps.parse-prompt.outputs.result).valid &&
          steps.check-duplicate.outputs.duplicate == 'false'
        run: |
          TRIGGER='${{ fromJSON(steps.parse-prompt.outputs.result).trigger }}'
          LABEL='${{ fromJSON(steps.parse-prompt.outputs.result).label }}'
          DESCRIPTION='${{ fromJSON(steps.parse-prompt.outputs.result).description }}'
          PROMPT='${{ fromJSON(steps.parse-prompt.outputs.result).prompt }}'
          FILENAME='${{ fromJSON(steps.parse-prompt.outputs.result).fileName }}'
          ISSUE_NUMBER='${{ github.event.issue.number }}'
          ISSUE_AUTHOR='${{ github.event.issue.user.login }}'
          
          cat > "prompts/$FILENAME" << 'PROMPT_EOF'
          # æç¤ºè©ç”± Issue #$ISSUE_NUMBER è²¢ç»
          # è²¢ç»è€…: @$ISSUE_AUTHOR

          trigger: "$TRIGGER"
          label: "$LABEL"
          description: "$DESCRIPTION"

          prompt: |
          PROMPT_EOF
          
          # è™•ç†å¤šè¡Œ prompt
          echo "$PROMPT" | sed 's/^/  /' >> "prompts/$FILENAME"

      - name: Commit and push
        if: |
          steps.check-approval.outputs.result != '' && 
          fromJSON(steps.check-approval.outputs.result).approved &&
          steps.parse-prompt.outputs.result != '' &&
          fromJSON(steps.parse-prompt.outputs.result).valid &&
          steps.check-duplicate.outputs.duplicate == 'false'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          FILENAME='${{ fromJSON(steps.parse-prompt.outputs.result).fileName }}'
          TRIGGER='${{ fromJSON(steps.parse-prompt.outputs.result).trigger }}'
          
          git add "prompts/$FILENAME"
          git commit -m "feat: add prompt $TRIGGER from #${{ github.event.issue.number }}"
          git push

      - name: Close issue with success message
        if: |
          steps.check-approval.outputs.result != '' && 
          fromJSON(steps.check-approval.outputs.result).approved &&
          steps.parse-prompt.outputs.result != '' &&
          fromJSON(steps.parse-prompt.outputs.result).valid &&
          steps.check-duplicate.outputs.duplicate == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const result = ${{ steps.parse-prompt.outputs.result }};
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `âœ… æç¤ºè©å·²æˆåŠŸåŠ å…¥ï¼\n\n**è©³ç´°è³‡è¨Šï¼š**\n- Trigger: \`${result.trigger}\`\n- æª”æ¡ˆ: \`prompts/${result.fileName}\`\n\næ„Ÿè¬æ‚¨çš„è²¢ç»ï¼ğŸ‰`
            });
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed',
              labels: ['prompt-contribution', 'approved']
            });

  validate-on-create:
    name: é©—è­‰æ–°å»º Issue
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    permissions:
      issues: write
    steps:
      - name: Validate issue format
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);
            
            if (!labels.includes('prompt-contribution')) {
              return;
            }
            
            const body = issue.body;
            
            // å¿«é€Ÿæ ¼å¼æª¢æŸ¥
            const triggerMatch = body.match(/### Trigger\s*\n+([^\n]+)/i);
            
            if (triggerMatch) {
              const trigger = triggerMatch[1].trim();
              const errors = [];
              
              if (!trigger.startsWith(':')) {
                errors.push('âš ï¸ Trigger æ‡‰ä»¥å†’è™Ÿ `:` é–‹é ­');
              }
              
              if (trigger.includes(' ')) {
                errors.push('âš ï¸ Trigger ä¸æ‡‰åŒ…å«ç©ºæ ¼');
              }
              
              if (errors.length > 0) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `æ„Ÿè¬æ‚¨çš„è²¢ç»ï¼åœ¨æäº¤å¯©æ ¸å‰ï¼Œè«‹æ³¨æ„ä»¥ä¸‹æ ¼å¼å•é¡Œï¼š\n\n${errors.join('\n')}\n\nè«‹ç·¨è¼¯ Issue ä¿®æ­£é€™äº›å•é¡Œã€‚`
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `æ„Ÿè¬æ‚¨çš„è²¢ç»ï¼æ‚¨çš„æç¤ºè©å·²æ”¶åˆ°ï¼Œæ­£åœ¨ç­‰å¾…ç¶­è­·è€…å¯©æ ¸ã€‚\n\nç¶­è­·è€…å¯ä»¥è¼¸å…¥ \`/approved\` ä¾†æ ¸å‡†æ­¤æç¤ºè©ã€‚`
                });
              }
            }

on:
  issues:
    types: [opened]
