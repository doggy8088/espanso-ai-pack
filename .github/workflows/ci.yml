name: Build and Release

on:
  push:
    branches: [main]
    paths:
      - 'package.json'
      - 'prompts/**'
      - '_manifest.yml'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_release:
        description: 'å¼·åˆ¶ç™¼ä½ˆï¼ˆè¦†è“‹ç¾æœ‰ Tagï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  validate:
    name: é©—è­‰æç¤ºè©æ ¼å¼
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Validate prompts
        run: bun run validate

  validate-espanso-package:
    name: é©—è­‰ Espanso å¥—ä»¶è¦æ ¼
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build package
        run: bun run build

      - name: Validate _manifest.yml structure
        run: |
          echo "ğŸ“‹ é©—è­‰ _manifest.yml æ ¼å¼..."
          
          # æª¢æŸ¥å¿…è¦æ¬„ä½
          required_fields=("name" "title" "description" "version" "author" "homepage" "tags")
          
          for field in "${required_fields[@]}"; do
            if ! grep -q "^${field}:" _manifest.yml; then
              echo "âŒ éŒ¯èª¤ï¼š_manifest.yml ç¼ºå°‘å¿…è¦æ¬„ä½: $field"
              exit 1
            fi
          done
          
          # é©—è­‰å¥—ä»¶åç¨±æ ¼å¼ï¼ˆåªèƒ½åŒ…å«å°å¯«å­—æ¯ã€æ•¸å­—å’Œé€£å­—è™Ÿï¼‰
          package_name=$(grep "^name:" _manifest.yml | cut -d'"' -f2 | tr -d ' ')
          if ! echo "$package_name" | grep -qE '^[a-z0-9-]+$'; then
            echo "âŒ éŒ¯èª¤ï¼šå¥—ä»¶åç¨±æ ¼å¼ä¸æ­£ç¢ºï¼Œåªèƒ½åŒ…å«å°å¯«å­—æ¯ã€æ•¸å­—å’Œé€£å­—è™Ÿ"
            echo "   ç›®å‰åç¨±: $package_name"
            exit 1
          fi
          
          # é©—è­‰ç‰ˆæœ¬è™Ÿæ ¼å¼ï¼ˆMAJOR.MINOR.PATCHï¼‰
          version=$(grep "^version:" _manifest.yml | sed 's/version: *"\?\([^"]*\)"\?/\1/' | tr -d ' ')
          if ! echo "$version" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "âŒ éŒ¯èª¤ï¼šç‰ˆæœ¬è™Ÿæ ¼å¼ä¸æ­£ç¢ºï¼Œæ‡‰ç‚º MAJOR.MINOR.PATCH æ ¼å¼"
            echo "   ç›®å‰ç‰ˆæœ¬: $version"
            exit 1
          fi
          
          echo "âœ… _manifest.yml æ ¼å¼é©—è­‰é€šé"
          echo "   å¥—ä»¶åç¨±: $package_name"
          echo "   ç‰ˆæœ¬è™Ÿ: $version"

      - name: Validate package.yml exists
        run: |
          echo "ğŸ“‹ é©—è­‰ package.yml æ˜¯å¦å­˜åœ¨..."
          if [ ! -f "dist/package.yml" ]; then
            echo "âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° dist/package.yml"
            exit 1
          fi
          echo "âœ… package.yml å­˜åœ¨"

      - name: Validate package.yml structure
        run: |
          echo "ğŸ“‹ é©—è­‰ package.yml çµæ§‹..."
          
          # æª¢æŸ¥æ˜¯å¦åŒ…å« matches
          if ! grep -q "^matches:" dist/package.yml; then
            echo "âŒ éŒ¯èª¤ï¼špackage.yml å¿…é ˆåŒ…å« matches æ¬„ä½"
            exit 1
          fi
          
          # çµ±è¨ˆ matches æ•¸é‡
          match_count=$(grep -c "trigger:" dist/package.yml || echo "0")
          if [ "$match_count" -eq 0 ]; then
            echo "âŒ éŒ¯èª¤ï¼špackage.yml æ²’æœ‰å®šç¾©ä»»ä½• matches"
            exit 1
          fi
          
          echo "âœ… package.yml çµæ§‹é©—è­‰é€šé"
          echo "   Matches æ•¸é‡: $match_count"

      - name: Validate trigger format
        run: |
          echo "ğŸ“‹ é©—è­‰ Trigger æ ¼å¼..."
          
          # æå–æ‰€æœ‰ triggers
          triggers=$(grep "trigger:" dist/package.yml | cut -d'"' -f2)
          
          # é©—è­‰æ¯å€‹ trigger æ˜¯å¦ä»¥ : é–‹é ­
          while IFS= read -r trigger; do
            if [[ ! "$trigger" =~ ^: ]]; then
              echo "âš ï¸  è­¦å‘Šï¼šå»ºè­° Trigger ä»¥å†’è™Ÿé–‹é ­ä»¥é¿å…èˆ‡ä¸€èˆ¬æ–‡å­—è¡çª: $trigger"
            fi
            
            # æª¢æŸ¥æ˜¯å¦åŒ…å«ç©ºæ ¼
            if [[ "$trigger" =~ [[:space:]] ]]; then
              echo "âŒ éŒ¯èª¤ï¼šTrigger ä¸æ‡‰åŒ…å«ç©ºæ ¼: $trigger"
              exit 1
            fi
          done <<< "$triggers"
          
          echo "âœ… Trigger æ ¼å¼é©—è­‰é€šé"

      - name: Validate README.md exists
        run: |
          echo "ğŸ“‹ é©—è­‰ README.md æ˜¯å¦å­˜åœ¨..."
          if [ ! -f "README.md" ]; then
            echo "âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° README.md"
            exit 1
          fi
          
          # æª¢æŸ¥ README é•·åº¦
          readme_lines=$(wc -l < README.md)
          if [ "$readme_lines" -lt 10 ]; then
            echo "âš ï¸  è­¦å‘Šï¼šREADME.md å…§å®¹éçŸ­ï¼ˆå°‘æ–¼ 10 è¡Œï¼‰"
          fi
          
          echo "âœ… README.md å­˜åœ¨"
          echo "   è¡Œæ•¸: $readme_lines"

          echo "ğŸ“‹ é©—è­‰ README.md å…§å®¹çµæ§‹..."
          required_sections=(
            "ç°¡ä»‹|Introduction"
            "ç‰¹è‰²|Features"
            "å®‰è£|Installation"
            "ä½¿ç”¨|Usage"
            "æç¤ºè©åˆ—è¡¨|Trigger"
            "æˆæ¬Š|License"
          )
          missing_sections=()

          for pattern in "${required_sections[@]}"; do
            if ! grep -Eq "^[#]+[[:space:]]+.*(${pattern})" README.md; then
              missing_sections+=("$pattern")
            fi
          done

          if [ "${#missing_sections[@]}" -ne 0 ]; then
            echo "âŒ éŒ¯èª¤ï¼šREADME.md ç¼ºå°‘å¿…è¦ç« ç¯€ï¼ˆä¾ Espanso Hub/æœ¬å°ˆæ¡ˆè¦ç¯„ï¼‰:"
            for section in "${missing_sections[@]}"; do
              echo "   - $section"
            done
            exit 1
          fi

          echo "âœ… README.md å…§å®¹çµæ§‹é©—è­‰é€šé"

      - name: Check for LICENSE
        run: |
          echo "ğŸ“‹ æª¢æŸ¥ LICENSE æª”æ¡ˆ..."
          if [ ! -f "LICENSE" ]; then
            echo "âš ï¸  è­¦å‘Šï¼šå»ºè­°åŠ å…¥ LICENSE æª”æ¡ˆ"
            echo "   å¦‚æœªæä¾›ï¼Œå°‡ä½¿ç”¨ Espanso Hub é è¨­çš„ MIT License"
          else
            echo "âœ… LICENSE æª”æ¡ˆå­˜åœ¨"
          fi

      - name: Validate YAML syntax
        run: |
          echo "ğŸ“‹ é©—è­‰ YAML èªæ³•..."
          
          # ä½¿ç”¨ bun çš„ YAML parser é©—è­‰
          cat > /tmp/validate-yaml.ts << 'EOF'
          import { readFile } from "fs/promises";
          import { parse } from "yaml";
          
          async function validateYaml(file: string) {
            try {
              const content = await readFile(file, "utf-8");
              parse(content);
              console.log(`âœ… ${file} YAML èªæ³•æ­£ç¢º`);
              return true;
            } catch (error) {
              console.error(`âŒ ${file} YAML èªæ³•éŒ¯èª¤:`, error);
              return false;
            }
          }
          
          const files = ["_manifest.yml", "dist/package.yml"];
          let allValid = true;
          
          for (const file of files) {
            const valid = await validateYaml(file);
            if (!valid) allValid = false;
          }
          
          if (!allValid) {
            process.exit(1);
          }
          EOF
          
          bun run /tmp/validate-yaml.ts

      - name: Package validation summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         Espanso å¥—ä»¶é©—è­‰å®Œæˆï¼                          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… æ‰€æœ‰å¿…è¦æª”æ¡ˆå­˜åœ¨ä¸”æ ¼å¼æ­£ç¢º"
          echo "âœ… å¥—ä»¶ç¬¦åˆ Espanso Hub è¦æ ¼"
          echo ""
          echo "ğŸ“¦ å¥—ä»¶è³‡è¨Šï¼š"
          grep "^name:" _manifest.yml
          grep "^version:" _manifest.yml
          grep "^title:" _manifest.yml
          echo ""
          echo "ğŸ‰ å¯ä»¥æº–å‚™ä¸Šæ¶åˆ° Espanso Hubï¼"

  build:
    name: å»ºç½®å¥—ä»¶
    runs-on: ubuntu-latest
    needs: [validate, validate-espanso-package]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build package
        run: bun run build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: espanso-ai-pack
          path: |
            dist/package.yml
            dist/index.html

  deploy-pages:
    name: éƒ¨ç½² GitHub Pages
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build package
        run: bun run build

      - name: Prepare Pages content
        run: |
          # è¤‡è£½å¿…è¦æª”æ¡ˆåˆ° dist ç›®éŒ„
          cp _manifest.yml dist/
          cp README.md dist/
          cp LICENSE dist/
          
          # å»ºç«‹ .nojekyll æª”æ¡ˆï¼ˆé¿å… GitHub Pages å¿½ç•¥æŸäº›æª”æ¡ˆï¼‰
          touch dist/.nojekyll

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  release:
    name: ç™¼ä½ˆ Release
    runs-on: ubuntu-latest
    needs: build
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check version change
        id: version_check
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "æ‰‹å‹•è§¸ç™¼ï¼Œè·³éç‰ˆæœ¬æª¢æŸ¥"
          else
            # æª¢æŸ¥ package.json æ˜¯å¦æœ‰è®Šæ›´
            if git diff HEAD^ HEAD -- package.json | grep -q '"version"'; then
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "åµæ¸¬åˆ° package.json version è®Šæ›´"
            else
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "package.json version æœªè®Šæ›´ï¼Œè·³éç™¼ä½ˆ"
            fi
          fi

      - name: Setup Bun
        if: steps.version_check.outputs.changed == 'true'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        if: steps.version_check.outputs.changed == 'true'
        run: bun install

      - name: Build package
        if: steps.version_check.outputs.changed == 'true'
        run: bun run build

      - name: Get version from package.json
        if: steps.version_check.outputs.changed == 'true'
        id: version
        run: |
          VERSION="v$(grep -Po '"version":\s*"\K[^"]*' package.json)"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ç‰ˆæœ¬è™Ÿ: $VERSION"

      - name: Delete existing tag if force release
        if: steps.version_check.outputs.changed == 'true' && github.event.inputs.force_release == 'true'
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "åˆªé™¤ç¾æœ‰ tag: $VERSION"
            git tag -d "$VERSION" || true
            git push origin ":refs/tags/$VERSION" || true
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push tag
        if: steps.version_check.outputs.changed == 'true'
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            if [ "${{ github.event.inputs.force_release }}" != "true" ]; then
              echo "Tag $VERSION å·²å­˜åœ¨ï¼Œè·³éç™¼ä½ˆ"
              echo "å¦‚éœ€è¦†è“‹ï¼Œè«‹ä½¿ç”¨æ‰‹å‹•è§¸ç™¼ä¸¦å•Ÿç”¨ã€Œå¼·åˆ¶ç™¼ä½ˆã€é¸é …"
              exit 1
            fi
          fi
          
          git tag -f "$VERSION"
          git push -f origin "$VERSION"

      - name: Generate changelog
        if: steps.version_check.outputs.changed == 'true'
        id: changelog
        run: |
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "## æç¤ºè©åˆ—è¡¨" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          for file in prompts/*.yml; do
            trigger=$(grep "^trigger:" "$file" | cut -d'"' -f2 || grep "^trigger:" "$file" | awk '{print $2}')
            label=$(grep "^label:" "$file" | cut -d'"' -f2 || grep "^label:" "$file" | awk '{print $2}')
            echo "- \`$trigger\` - $label" >> $GITHUB_OUTPUT
          done
          echo "" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Delete existing release if force release
        if: steps.version_check.outputs.changed == 'true' && github.event.inputs.force_release == 'true'
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          gh release delete "$VERSION" --yes || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        if: steps.version_check.outputs.changed == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: ${{ steps.version.outputs.VERSION }}
          body: |
            # Espanso AI Pack ${{ steps.version.outputs.VERSION }}

            ${{ steps.changelog.outputs.CHANGELOG }}

            ## å®‰è£æ–¹å¼

            ### å¾ GitHub å®‰è£
            ```bash
            espanso install espanso-ai-pack --git https://github.com/${{ github.repository }} --external
            ```

            ### å¾ GitHub Pages ä¸‹è¼‰
            å‰å¾€ [ä¸‹è¼‰é é¢](https://${{ github.repository_owner }}.github.io/espanso-ai-pack/) ä¸‹è¼‰æª”æ¡ˆä¸¦æ‰‹å‹•å®‰è£ã€‚

            æˆ–æ‰‹å‹•ä¸‹è¼‰ `package.yml` æ”¾åˆ° espanso çš„ match ç›®éŒ„ã€‚

            **ä¸‹è¼‰é é¢**: https://${{ github.repository_owner }}.github.io/espanso-ai-pack/
          files: |
            dist/package.yml
          draft: false
          prerelease: false
